## 1) Executive Summary
- A Fase 1 existe para remover risco operacional no caminho crítico `checkout -> webhook`, sem reescrever o monólito e sem quebrar contrato HTTP.
- O foco é introduzir camada de aplicação com dois use cases explícitos e manter controllers como inbound adapters finos.
- A mudança é incremental (Strangler Fig): endpoint, path, DTO e semântica principal permanecem.
- `POST /v1/payments/checkout` continua retornando `CheckoutCreateResponse` com `orderId/checkoutUrl/messageText`.
- `*/v1/payments/mercadopago/notification` continua retornando `MercadoPagoWebhookResponse` com `decision/order/payment/reason`.
- **NOVO**: `CreateCheckoutUseCase` para separar orquestração de regra e boundary HTTP.
- **NOVO**: `ProcessMpWebhookUseCase` para consolidar token validation, fetch MP e decisão transacional.
- **NOVO**: Ports mínimos (`PaymentGatewayPort`, `OrderStorePort`, `PaymentStorePort`) com adapters sobre infra atual (WebClient/JPA).
- Não entra na Fase 1: mudança de contrato, dedup por `eventId`, hardening completo (retry policy avançada, assinatura MP, observabilidade completa).
- Critérios de sucesso: build/test verde (`mvn test`), snapshot de contrato sem regressão, rollback simples por `git revert` (sem migration destrutiva).

## 2) AS-IS — mapa de dependências REAL
### Fluxo A: Checkout
- Cadeia atual:
  - Controller: [PaymentsController.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/api/PaymentsController.java#L22)
  - Service: [CheckoutService.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/CheckoutService.java#L30)
  - Repo/WebClient: [OrderRepository.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/orders/OrderRepository.java#L8), [MercadoPagoClient.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/mp/MercadoPagoClient.java#L40)
- Acoplamentos/riscos:
  - `@Transactional` cobre chamada externa MP (`createPreference().block()`), aumentando lock time e risco de TX longa.
  - Logging expõe `notificationUrl` completo (pode conter token query).
  - Sem camada intermediária entre HTTP e infraestrutura.
- Transações e side effects:
  - Salva `orders` com status `CREATED`.
  - Chama MP para criar preferência.
  - Em erro da MP, exceção sobe para handler global; não há compensação explícita de status do pedido.

### Fluxo B: Webhook Mercado Pago
- Cadeia atual:
  - Controller: [PaymentsController.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/api/PaymentsController.java#L27)
  - Service de orquestração: [MercadoPagoWebhookService.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/MercadoPagoWebhookService.java#L30)
  - Service transacional: [MercadoPagoPaymentTxService.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/MercadoPagoPaymentTxService.java#L25)
  - Repo/WebClient: [PaymentRepository.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/PaymentRepository.java#L16), [OrderRepository.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/orders/OrderRepository.java#L8), [MercadoPagoClient.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/mp/MercadoPagoClient.java#L26)
- Acoplamentos/riscos:
  - Controller conhece parsing de `paymentId` (query/body), mas sem abstração de caso de uso.
  - Webhook GET/POST aceito no controller, porém security libera apenas POST.
  - Quando `external_reference` ausente, código tenta `upsertPayment(..., orderId=null, ...)`, mas `payments.order_id` é `NOT NULL` ([PaymentsEntity.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/PaymentsEntity.java#L27), [V4__align_schema_to_entities.sql](/mnt/c/repositorio/com.shkgroups.agent/src/main/resources/db/migration/V4__align_schema_to_entities.sql#L93)).
- Transações e side effects:
  - Fora TX: valida token e busca pagamento no MP.
  - Em TX: upsert em `payments` com lock pessimista por `payment_id`, busca `order`, possivelmente muda `order.status` para `PAID`.
  - Idempotência parcial: unicidade por `payment_id` + lock pessimista + retry por `DataIntegrityViolationException`.

## 3) TO-BE Fase 1 — arquitetura alvo incremental
Diagrama textual Fase 1:
- `PaymentsController` -> `CreateCheckoutUseCase` -> `OrderStorePort` + `PaymentGatewayPort`
- `PaymentsController` -> `ProcessMpWebhookUseCase` -> `PaymentGatewayPort` -> `OrderStorePort` + `PaymentStorePort`
- `Adapters`:
  - `MercadoPagoGatewayAdapter` implementa `PaymentGatewayPort` delegando para `MercadoPagoClient`
  - `JpaOrderStoreAdapter` implementa `OrderStorePort` delegando para `OrderRepository`
  - `JpaPaymentStoreAdapter` implementa `PaymentStorePort` delegando para `PaymentRepository`

Pacotes novos (Fase 1):
- **NOVO** `com.shkgroups.application.payments.usecase`
- **NOVO** `com.shkgroups.ports.payments`
- **NOVO** `com.shkgroups.adapters.payments.gateway`
- **NOVO** `com.shkgroups.adapters.payments.persistence`

Assinaturas sugeridas (mínimas):
- **NOVO** `CreateCheckoutUseCase`
  - `CheckoutCreateResponse execute(CheckoutCreateRequest request);`
- **NOVO** `ProcessMpWebhookUseCase`
  - `MercadoPagoWebhookResponse execute(String token, String paymentId);`
- **NOVO** `PaymentGatewayPort`
  - `MpPaymentData getPayment(String paymentId);`
  - `String createCheckoutPreference(CreatePreferenceCommand cmd);`
- **NOVO** `OrderStorePort`
  - `OrderData createCreatedOrder(CheckoutCreateRequest request, String orderId);`
  - `Optional<OrderData> findByOrderId(String orderId);`
  - `void markPaidIfCreated(String orderId);`
  - `void markCanceled(String orderId);`
- **NOVO** `PaymentStorePort`
  - `void upsert(String paymentId, String orderId, String status, BigDecimal amount);`

## 4) Lista de mudanças por arquivo (cirúrgico)
1. **NOVO** Arquivo: `/src/main/java/com/shkgroups/application/payments/usecase/CreateCheckoutUseCase.java`
- Mudança proposta: extrair orquestração de checkout; criar order, chamar gateway, retornar DTO atual.
- Motivação: remover lógica de aplicação do service legado e preparar strangler.
- Risco: regressão de status/orderId em erro MP.
- Rollback: rewiring do controller para `CheckoutService` legado.
- Teste associado: unit com mocks de `OrderStorePort` e `PaymentGatewayPort`.

2. **NOVO** Arquivo: `/src/main/java/com/shkgroups/application/payments/usecase/ProcessMpWebhookUseCase.java`
- Mudança proposta: consolidar validação token/paymentId, fetch MP e decisão.
- Motivação: centralizar regra de decisão e isolar controller.
- Risco: mudar `reason`/decisão acidentalmente.
- Rollback: rewiring para `MercadoPagoWebhookService` legado.
- Teste associado: unit matrix de status MP + token inválido + `payment_id_missing`.

3. **NOVO** Arquivo: `/src/main/java/com/shkgroups/ports/payments/PaymentGatewayPort.java`
- Mudança proposta: interface de saída para MP (get payment + create preference).
- Motivação: desacoplar use case de WebClient e records de infra.
- Risco: mapeamento incorreto de campos MP (`external_reference`, `transaction_amount`).
- Rollback: remover binding da port e injetar `MercadoPagoClient` direto nos use cases.
- Teste associado: adapter test com mock de `MercadoPagoClient`.

4. **NOVO** Arquivo: `/src/main/java/com/shkgroups/ports/payments/OrderStorePort.java`
- Mudança proposta: wrapper mínimo para operações de `orders`.
- Motivação: retirar dependência JPA direta da aplicação.
- Risco: perder semântica de atualização condicional de status.
- Rollback: use case chamar `OrderRepository` legado.
- Teste associado: integration test persistência e transição `CREATED -> PAID`.

5. **NOVO** Arquivo: `/src/main/java/com/shkgroups/ports/payments/PaymentStorePort.java`
- Mudança proposta: wrapper mínimo para upsert idempotente de `payments`.
- Motivação: preservar lock/unicidade e esconder detalhe JPA.
- Risco: alterar comportamento de corrida concorrente.
- Rollback: restaurar `upsertPayment` em service legado.
- Teste associado: replay test com mesmo `paymentId` sem duplicação.

6. **NOVO** Arquivo: `/src/main/java/com/shkgroups/adapters/payments/gateway/MercadoPagoGatewayAdapter.java`
- Mudança proposta: implementar `PaymentGatewayPort` delegando para [MercadoPagoClient.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/mp/MercadoPagoClient.java#L12).
- Motivação: manter infra atual sem reescrever cliente.
- Risco: exception mapping divergente.
- Rollback: remover adapter e usar client direto.
- Teste associado: unit test de mapeamento request/response.

7. **NOVO** Arquivo: `/src/main/java/com/shkgroups/adapters/payments/persistence/JpaOrderStoreAdapter.java`
- Mudança proposta: implementar `OrderStorePort` sobre [OrderRepository.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/orders/OrderRepository.java#L8).
- Motivação: transição incremental para ports.
- Risco: inconsistência de timestamps/status.
- Rollback: fallback para service legado.
- Teste associado: integration test criação de order e compensação de cancelamento.

8. **NOVO** Arquivo: `/src/main/java/com/shkgroups/adapters/payments/persistence/JpaPaymentStoreAdapter.java`
- Mudança proposta: implementar `PaymentStorePort` mantendo lock pessimista e recovery de `DataIntegrityViolationException`.
- Motivação: preservar idempotência atual.
- Risco: regressão no tratamento de corrida.
- Rollback: reinstalar método `upsertPayment` no transacional legado.
- Teste associado: integration test concorrência mínima (2 threads, mesmo `paymentId`).

9. Arquivo atual: [PaymentsController.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/api/PaymentsController.java#L17)
- Mudança proposta: trocar dependências de `CheckoutService/MercadoPagoWebhookService` para os dois use cases.
- Motivação: controller thin de verdade.
- Risco: alteração involuntária de parsing `paymentId`.
- Rollback: voltar injeção para services antigos.
- Teste associado: MockMvc contrato de `POST /checkout` e `GET|POST /notification`.

10. Arquivo atual: [CheckoutService.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/CheckoutService.java#L21)
- Mudança proposta: manter por compat temporária, mas retirar uso direto do controller; opcionalmente virar façade delegando ao use case.
- Motivação: rollback fácil na Fase 1.
- Risco: duplicação temporária de caminho.
- Rollback: controller volta para esse service em 1 commit.
- Teste associado: smoke test de wiring Spring.

11. Arquivo atual: [MercadoPagoWebhookService.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/MercadoPagoWebhookService.java#L15)
- Mudança proposta: manter por compat temporária; delegar ao `ProcessMpWebhookUseCase` ou desativar uso direto.
- Motivação: migração segura sem big-bang.
- Risco: dupla fonte de verdade.
- Rollback: religar service antigo no controller.
- Teste associado: regressão de decisões para token inválido/pagamento ausente.

12. Arquivo atual: [SecurityConfig.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/security/SecurityConfig.java#L39)
- Mudança proposta: liberar `GET` e `POST` para `/v1/payments/mercadopago/notification`.
- Motivação: alinhar security com controller e tasks.
- Risco: superfície pública maior, mitigada por token validation no use case.
- Rollback: voltar para `POST` apenas.
- Teste associado: MockMvc/security test para GET sem API key retornando 200 com `decision=IGNORE` quando token inválido.

13. Arquivo atual: [ApiKeyAuthFilter.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/security/ApiKeyAuthFilter.java#L56)
- Mudança proposta: em `shouldNotFilter`, liberar webhook para `GET` e `POST`.
- Motivação: evitar 401 indevido em GET webhook.
- Risco: bypass indevido em path errado.
- Rollback: voltar condição original.
- Teste associado: teste de filtro por método/path.

14. **NOVO** testes de contrato e integração em `src/test/java/com/shkgroups/payments/...`
- Mudança proposta: criar classes de teste reais no source set correto.
- Motivação: hoje quase não há cobertura executável.
- Risco: flakiness se depender de ambiente externo.
- Rollback: manter somente unit tests e mock de gateway.
- Teste associado: suíte P0/P1 listada na seção 6.

## 5) Estratégia de migração sem quebrar nada
- Strangler Fig aplicado:
  - Manter endpoints e DTOs atuais.
  - Trocar apenas o “miolo” chamado pelo controller.
  - Services legados ficam temporariamente como fallback.
- Compatibilidade:
  - Sem alterar paths: `/v1/payments/checkout` e `/v1/payments/mercadopago/notification`.
  - Sem alterar DTOs públicos.
  - Sem alterar schema/migrations na Fase 1.
- Validação de compat:
  - Contract tests (MockMvc) comparando status code/body.
  - Snapshot JSON dos responses de happy-path e erro principal.
  - Reexecução de collection Postman atual (checkout + webhook GET/POST + replay).

## 6) Plano de testes Fase 1 (padrão fintech)
- Unit tests (mock ports):
  - `CreateCheckoutUseCaseTest`: access token ausente com static URL; create preference sucesso; create preference falha com compensação (`markCanceled`).
  - `ProcessMpWebhookUseCaseTest`: token inválido; paymentId ausente; payment null; `no_external_reference`; `order_not_found`; status approved/pending/rejected; amount mismatch.
- Integration tests (ideal com Testcontainers + Postgres):
  - `WebhookReplayIT`: duas execuções mesmo `paymentId` não duplicam `payments`.
  - `WebhookNoExternalReferenceIT`: não tenta persistir `order_id=null`.
  - `CheckoutTxBoundaryIT`: confirmar que chamada gateway ocorre fora de transação de persistência inicial.
- Regressão de contrato:
  - MockMvc `POST /v1/payments/checkout` -> 200 + `orderId`, `checkoutUrl`, `messageText`.
  - MockMvc `GET|POST /v1/payments/mercadopago/notification` token inválido -> 200 + `decision=IGNORE`.
  - Snapshot mínimo: status codes + campos JSON obrigatórios.

## 7) Plano de PRs (mínimo 2 PRs)
1. PR1: estrutura de Application + controllers thin
- Escopo:
  - Criar **NOVO** `CreateCheckoutUseCase`, **NOVO** `ProcessMpWebhookUseCase`.
  - Ajustar [PaymentsController.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/payments/api/PaymentsController.java#L17) para usar use cases.
  - Ajustar segurança webhook GET/POST ([SecurityConfig.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/security/SecurityConfig.java#L39), [ApiKeyAuthFilter.java](/mnt/c/repositorio/com.shkgroups.agent/src/main/java/com/shkgroups/security/ApiKeyAuthFilter.java#L56)).
- Checklist:
  - Compila.
  - Sem mudança de DTO/path.
  - Contract tests básicos passando.

2. PR2: ports + adapters mínimos + testes essenciais
- Escopo:
  - Criar **NOVO** `PaymentGatewayPort`, **NOVO** `OrderStorePort`, **NOVO** `PaymentStorePort`.
  - Criar adapters JPA/WebClient mínimos.
  - Migrar use cases para depender de ports.
  - Adicionar unit + integration tests de replay/concorrência mínima.
- Checklist:
  - Idempotência preservada.
  - `mvn test` verde.
  - Sem migration nova.
  - Rollback por revert de PR2 não quebra PR1.

## 8) Checklist final de execução
- Comandos:
  - `mvn -q -DskipTests compile`
  - `mvn test`
  - `mvn -Dtest=*Payments* test`
- Rotas validadas:
  - `POST /v1/payments/checkout`
  - `GET /v1/payments/mercadopago/notification`
  - `POST /v1/payments/mercadopago/notification`
- Rollback plan:
  - Revert PR2 completo.
  - Se necessário, revert PR1 e religar controller para services legados.
  - Nenhuma migration de banco na Fase 1, então rollback é só código/wiring.
